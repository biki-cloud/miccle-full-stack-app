# FastAPIプロジェクト - 開発

## カスタムドメインの`localhost`での開発

`localhost`以外のドメインを使用したい場合があります。たとえば、サブドメインが必要なクッキーに問題がある場合や、Chromeが`localhost`の使用を許可していない場合などです。

その場合、2つのオプションがあります。下記の**カスタムIPを使用した開発**セクションにある手順でシステムの`hosts`ファイルを変更するか、または`localhost.tiangolo.com`を使用することができます。これは、`localhost`（IP `127.0.0.1`）およびそのサブドメインを指すように設定されています。実際のドメインであるため、ブラウザーは開発中に設定したクッキーやその他の情報を保存します。

プロジェクトを生成する際にデフォルトのCORS有効なドメインを使用した場合、`localhost.tiangolo.com`が許可されています。そうでない場合は、`.env`ファイルの`BACKEND_CORS_ORIGINS`変数のリストに追加する必要があります。

この設定をスタックに適用するには、以下の**開発用ドメインを変更**セクションに従って、ドメイン`localhost.tiangolo.com`を使用してください。

これらの手順を実行した後、http://localhost.tiangolo.com を開くと、ローカルで実行されているスタックによって提供されます。

### 最後のセクションにある対応する利用可能なURLを確認してください。

## カスタムIPを使用した開発

Dockerを`127.0.0.1`（`localhost`）以外のIPアドレスで実行している場合は、いくつかの追加手順を実行する必要があります。これは、カスタムの仮想マシンを実行している場合や、Dockerがネットワーク内の別のマシンにある場合に該当します。

その場合、カスタムIP（たとえば `192.168.99.150`）で偽のローカルドメイン（`dev.example.com`）を使用し、コンピューターがそのドメインがカスタムIPで提供されていると思わせる必要があります。

そのようなカスタムドメインを持っている場合は、`.env`ファイルの`BACKEND_CORS_ORIGINS`変数のリストに追加する必要があります。

* テキストエディタを使用して管理者権限で`hosts`ファイルを開きます：

  * **Windowsの場合の注意点**：Windowsの場合は、メインのWindowsメニューを開き、"notepad"を検索し、それに右クリックして、"管理者として開く"などのオプションを選択します。 次に、"ファイル"メニューをクリックし、"ファイルを開く"を選択し、ディレクトリ`c:\Windows\System32\Drivers\etc\`に移動し、拡張子`.txt`の代わりに "すべてのファイル"を表示するオプションを選択し、`hosts`ファイルを開きます。
  * **MacとLinuxの場合の注意点**：`hosts`ファイルはおそらく`/etc/hosts`にありますので、ターミナルで実行して`sudo nano /etc/hosts`を実行して編集できます。

* それに追加して、カスタムIP（たとえば `192.168.99.150`）とスペース、および偽のローカルドメイン `dev.example.com` を含む新しい行を`hosts`ファイルに追加します。

新しい行は次のようになります：
192.168.99.150 dev.example.com


* ファイルを保存します。
  * **Windowsの場合の注意点**：ファイルを`.txt`の拡張子なしで "すべてのファイル"として保存することを確認してください。 Windowsはデフォルトで拡張子を追加しようとします。ファイルは拡張子なしで保存されていることを確認してください。

これにより、コンピューターは偽のローカルドメインがそのカスタムIPで提供されていると思い込み、ブラウザーに`dev.example.com`に移動するように要求されたときに、実際にはコンピューターで実行されているローカルなサーバーと通信します。

この設定をスタックに適用するには、以下の**開発用ドメインを変更**セクションに従って、ドメイン `dev.example.com` を使用してください。

これらの手順を実行した後、http://dev.example.com を開くと、ローカルで実行されているスタックによって提供されます。

最後のセクションにある対応する利用可能なURLを確認してください。

## 開発用 "ドメイン" の変更

`localhost`以外のドメインをローカルスタックで使用する必要がある場合は、使用するドメインがスタックが設定されているIPを指すように確認する必要があります。

例えば、APIドキュメント（Swagger UI）があなたのAPIがどこにあるかを知るために、Docker Composeの設定を簡素化するために、開発用にそのドメインを使用していることを知らせるべきです。

* `./.env`にあるファイルを開きます。次のような行があるはずです：

```
DOMAIN=localhost
```

* 使用するドメインに変更します。例えば：

```
DOMAIN=localhost.tiangolo.com
```

その変数はDocker Composeファイルで使用されます。

その後、スタックを再起動できます：

```bash
docker compose up -d
```

そして、最後のセクションにある対応する利用可能なURLすべてを確認します。

## Docker Composeファイルと環境変数

メインの `docker-compose.yml` ファイルには、スタック全体に適用されるすべての設定があり、`docker compose`によって自動的に使用されます。

また、ソースコードをボリュームとしてマウントするなど、開発用のオーバーライドがある `docker-compose.override.yml` もあります。これは `docker compose` によって自動的に使用され、`docker-compose.yml` の上にオーバーライドを適用します。

これらのDocker Composeファイルは、コンテナ内に環境変数として注入される設定を含む `.env` ファイルを使用します。

また、`docker compose` コマンドを呼び出す前にスクリプトで設定された環境変数からいくつかの追加設定を使用します。

## .env ファイル

`.env` ファイルは、すべての設定、生成されたキー、パスワードなどを含むファイルです。

ワークフローによっては、例えばプロジェクトが公開されている場合、Gitから除外したい場合があります。その場合、プロジェクトをビルドまたはデプロイする際にCIツールがそれを取得する方法を設定する必要があります。

それを行う一つの方法は、各環境変数をCI/CDシステムに追加し、`docker-compose.yml` ファイルを更新して、`.env` ファイルを読み込む代わりにその特定の環境変数を読み込むようにすることです。

### Pre-commitsとコードリント

コードのリントとフォーマットには[pre-commit](https://pre-commit.com/)というツールを使用しています。

これをインストールすると、gitでコミットを作成する直前に実行されます。これにより、コードが一貫性を持ってフォーマットされ、コミットされる前に確認されます。

プロジェクトのルートには、設定が記述された`.pre-commit-config.yaml`というファイルがあります。

#### 自動的に実行するためにpre-commitをインストールする

`pre-commit`はすでにプロジェクトの依存関係の一部ですが、もし好むならば[公式のpre-commitドキュメント](https://pre-commit.com/)に従ってグローバルにインストールすることもできます。

`pre-commit`ツールをインストールし、利用可能にした後、各コミットの前に自動的に実行されるように、ローカルリポジトリにそれを"インストール"する必要があります。

Poetryを使用して、以下のように実行できます：

```bash
❯ poetry run pre-commit install
pre-commit installed at .git/hooks/pre-commit
```

これで、例えば以下のようにコミットを試みるたびに、pre-commitが自動的に実行されます：

```bash
git commit
```

...pre-commitは、コミットしようとしているコードを実行し、チェックし、フォーマットし、そのコードを再度gitで追加（ステージング）するように求めます。

その後、修正/修正されたファイルを再度`git add`でき、今度はコミットできます。

#### 手動でpre-commitフックを実行する

また、すべてのファイルで`pre-commit`を手動で実行することもできます。Poetryを使用して以下のように実行できます：

```bash
❯ poetry run pre-commit run --all-files
check for added large files..............................................Passed
check toml...............................................................Passed
check yaml...............................................................Passed
ruff.....................................................................Passed
ruff-format..............................................................Passed
eslint...................................................................Passed
prettier.................................................................Passed
```

## URLs

本番環境またはステージング環境のURLは、これらと同じパスを使用しますが、独自のドメインを使用します。

### 開発用URL

ローカル開発用の開発URL。

フロントエンド: http://localhost

バックエンド: http://localhost/api/

自動インタラクティブドキュメント（Swagger UI）: http://localhost/docs

自動代替ドキュメント（ReDoc）: http://localhost/redoc

Adminer: http://localhost:8080

Traefik UI: http://localhost:8090

### カスタムドメインを使用したlocalhostでの開発用URL

ローカル開発用の開発URL。

フロントエンド: http://localhost.tiangolo.com

バックエンド: http://localhost.tiangolo.com/api/

自動インタラクティブドキュメント（Swagger UI）: http://localhost.tiangolo.com/docs

自動代替ドキュメント（ReDoc）: http://localhost.tiangolo.com/redoc

Adminer: http://localhost.tiangolo.com:8080

Traefik UI: http://localhost.tiangolo.com:8090